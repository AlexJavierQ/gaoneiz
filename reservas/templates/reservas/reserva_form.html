{% extends 'base.html' %}
{% load static crispy_forms_tags %}

{% block title %}Nueva Reserva - Cámara de Comercio de Loja{% endblock %}

{% block extra_css %}
<style>
    /* Estilo para el panel de resumen que se mantiene fijo al hacer scroll */
    .summary-panel {
        position: sticky;
        top: 20px;
    }

    /* Transición suave para los elementos que aparecen y desaparecen */
    .dynamic-info {
        transition: all 0.3s ease-in-out;
    }

    .form-control,
    .form-select {
        padding: 0.75rem 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <form method="post" id="reservaForm" novalidate>
        {% csrf_token %}
        <div class="row g-4 justify-content-center">

            <div class="col-lg-7">
                <div class="card shadow-sm border-0 rounded-4">
                    <div class="card-header bg-primary bg-gradient text-white border-0 py-3">
                        <h4 class="mb-0 fw-bold">
                            <i class="fas fa-calendar-plus me-2"></i>
                            Completa tu Solicitud de Reserva
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}

                        {{ form|crispy }}

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'reservas:lugares_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Volver a Lugares
                            </a>
                            <button type="submit" id="submit-button" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="summary-panel">
                    <div id="lugar-info-panel" class="card border-0 shadow-sm rounded-4 mb-4" style="display: none;">
                        <div class="card-body p-4">
                            <h5 class="card-title text-primary fw-bold mb-3">Detalles del Lugar</h5>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span><i class="fas fa-users me-2 text-muted"></i>Capacidad Máxima</span>
                                    <strong id="capacidad" class="text-dark"></strong>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span><i class="fas fa-dollar-sign me-2 text-muted"></i>Precio por Hora</span>
                                    <strong id="precio" class="text-dark"></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="costo-estimado-panel" class="dynamic-info" style="display: none;">
                        <div class="alert alert-success p-4">
                            <h5 class="alert-heading fw-bold">Costo Estimado</h5>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span>Duración:</span>
                                <span id="duracion" class="fw-bold">0 horas</span>
                            </div>
                            <div class="d-flex justify-content-between fs-4 mt-2">
                                <span class="fw-bold">Total:</span>
                                <span id="costo-total" class="fw-bolder">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 bg-light rounded-4 mt-4">
                        <div class="card-body p-4">
                            <h6 class="mb-3 text-dark fw-bold"><i class="fas fa-info-circle me-2"></i>A Considerar:</h6>
                            <ul class="list-unstyled text-secondary small">
                                <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Las reservas
                                    requieren aprobación administrativa.</li>
                                <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Solo los socios
                                    activos pueden realizar reservas.</li>
                                <li><i class="fas fa-check-circle text-success me-2"></i>Puede cancelar su reserva hasta
                                    24 horas antes del inicio.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script id="lugares-data" type="application/json">
    {{ lugares_data_json|safe }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- OBTENCIÓN DE ELEMENTOS DEL DOM ---
        const lugarSelect = document.querySelector('#id_lugar');
        const fechaInicioInput = document.querySelector('#id_fecha_inicio');
        const fechaFinInput = document.querySelector('#id_fecha_fin');
        const submitButton = document.getElementById('submit-button');

        // Paneles dinámicos
        const lugarInfoPanel = document.getElementById('lugar-info-panel');
        const costoEstimadoPanel = document.getElementById('costo-estimado-panel');

        // Elementos de texto a actualizar
        const capacidadSpan = document.getElementById('capacidad');
        const precioSpan = document.getElementById('precio');
        const duracionSpan = document.getElementById('duracion');
        const costoTotalSpan = document.getElementById('costo-total');

        // --- DATOS Y ESTADO ---
        const lugaresJson = JSON.parse(document.getElementById('lugares-data').textContent);
        const lugaresData = lugaresJson.reduce((obj, item) => {
            obj[item.id] = {
                nombre: item.nombre,
                capacidad: item.tipo__capacidad_maxima,
                precio: item.tipo__precio_por_hora
            };
            return obj;
        }, {});
        let lugarSeleccionado = null;

        // --- FUNCIONES ---
        function actualizarInfoLugar() {
            const lugarId = lugarSelect.value;
            lugarSeleccionado = lugarId && lugaresData[lugarId] ? lugaresData[lugarId] : null;

            if (lugarSeleccionado) {
                capacidadSpan.textContent = `${lugarSeleccionado.capacidad} personas`;
                precioSpan.textContent = `$${parseFloat(lugarSeleccionado.precio).toFixed(2)}`;
                lugarInfoPanel.style.display = 'block';
            } else {
                lugarInfoPanel.style.display = 'none';
            }
            calcularCosto();
        }

        function calcularCosto() {
            const inicio = fechaInicioInput.value ? new Date(fechaInicioInput.value) : null;
            const fin = fechaFinInput.value ? new Date(fechaFinInput.value) : null;

            if (lugarSeleccionado && inicio && fin && fin > inicio) {
                const horas = (fin - inicio) / (1000 * 60 * 60);
                const costo = horas * parseFloat(lugarSeleccionado.precio);

                duracionSpan.textContent = `${horas.toFixed(1)} horas`;
                costoTotalSpan.textContent = `$${costo.toFixed(2)}`;
                costoEstimadoPanel.style.display = 'block';
                submitButton.disabled = false;
            } else {
                costoEstimadoPanel.style.display = 'none';
                if (fin && inicio && fin <= inicio) {
                    submitButton.disabled = true;
                }
            }
        }

        // --- EVENT LISTENERS ---
        if (lugarSelect) lugarSelect.addEventListener('change', actualizarInfoLugar);
        if (fechaInicioInput) fechaInicioInput.addEventListener('change', calcularCosto);
        if (fechaFinInput) fechaFinInput.addEventListener('change', calcularCosto);

        // --- INICIALIZACIÓN ---
        if (lugarSelect) {
            actualizarInfoLugar();
        }
    });
</script>
{% endblock %}